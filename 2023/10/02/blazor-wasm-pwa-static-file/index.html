<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>[Blazor] PWA 靜態檔案問題 | Secret Note</title>
  <meta name="description" content="記錄一些自己記不住的東西" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Secret Note" type="application/atom+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在 Blazor WebAssembly 中可以開啟 PWA 的模式，也就是會產生 Service Worker，要加入像是 Excel 或是 PDF 到靜態檔案，會發現在本機開發時都能夠正常下載的檔案，怎麼上到掛 domain 的 server 就會去走 routing，跟預期的差很多，今天會來解析中間發生了什麼事情。">
<meta property="og:type" content="article">
<meta property="og:title" content="[Blazor] PWA 靜態檔案問題">
<meta property="og:url" content="http://jiaming0708.github.io/2023/10/02/blazor-wasm-pwa-static-file/index.html">
<meta property="og:site_name" content="Secret Note">
<meta property="og:description" content="在 Blazor WebAssembly 中可以開啟 PWA 的模式，也就是會產生 Service Worker，要加入像是 Excel 或是 PDF 到靜態檔案，會發現在本機開發時都能夠正常下載的檔案，怎麼上到掛 domain 的 server 就會去走 routing，跟預期的差很多，今天會來解析中間發生了什麼事情。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="http://jiaming0708.github.io/images/blazor.jpg">
<meta property="article:published_time" content="2023-10-02T06:13:19.000Z">
<meta property="article:modified_time" content="2023-10-02T06:13:19.000Z">
<meta property="article:author" content="Jimmy Ho">
<meta property="article:tag" content="Blazor">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://jiaming0708.github.io/images/blazor.jpg">
    
  <link href="//fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="preload">
  <link href="//fonts.googleapis.com/css?family=Roboto+Mono" rel="preload">
  <link href='//cdnjs.cloudflare.com/ajax/libs/node-waves/0.7.6/waves.min.css' rel='stylesheet'>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5LXTGJNLYY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-5LXTGJNLYY');
    </script>
  
  
    <script data-ad-client="ca-pub-6806360411033447" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Secret Note | 機密檔案
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-blazor-wasm-pwa-static-file"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2023/10/02/blazor-wasm-pwa-static-file/">
    	[Blazor] PWA 靜態檔案問題
    </a>
  </h2>

	<time datetime="2023-10-02">
		2023-10-02
	</time>

	
    
    <div class='cats'>
        <a href="/categories/Frontend/">Frontend</a>, <a href="/categories/Frontend/Blazor/">Blazor</a>
    </div>
    
        <span class="readtime">1:01</span>
    


	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reproduce"><span class="toc-number">1.</span> <span class="toc-text">Reproduce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%88%E6%A1%88%E5%BB%BA%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">專案建置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%93%ACserver"><span class="toc-number">1.2.</span> <span class="toc-text">模擬server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PWA"><span class="toc-number">1.3.</span> <span class="toc-text">PWA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-Worker"><span class="toc-number">1.4.</span> <span class="toc-text">Service Worker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#service-worker-js"><span class="toc-number">1.4.1.</span> <span class="toc-text">service-worker.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service-woker-published-js"><span class="toc-number">1.4.2.</span> <span class="toc-text">service-woker.published.js</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#onInstall"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">onInstall</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#onActivate"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">onActivate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#onFetch"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">onFetch</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service-worker-assets-js"><span class="toc-number">1.4.3.</span> <span class="toc-text">service-worker-assets.js</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fix"><span class="toc-number">2.</span> <span class="toc-text">Fix</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80"><span class="toc-number">2.1.</span> <span class="toc-text">解法一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C"><span class="toc-number">2.2.</span> <span class="toc-text">解法二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%89"><span class="toc-number">2.3.</span> <span class="toc-text">解法三</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol></section>
	
	<section class="article typo">
	  
	  <div class="article-tags tags">
      
        <a href="/tags/Blazor/">Blazor</a>
      
	  </div>
		
  	<div class="article-entry" itemprop="articleBody">
			<p>在 Blazor WebAssembly 中可以開啟 PWA 的模式，也就是會產生 Service Worker，要加入像是 Excel 或是 PDF 到靜態檔案，會發現在本機開發時都能夠正常下載的檔案，怎麼上到掛 domain 的 server 就會去走 routing，跟預期的差很多，今天會來解析中間發生了什麼事情。</p>
<span id="more"></span>

<blockquote>
<p>以下版本為 Dotnet 7.0.4</p>
</blockquote>
<h2 id="Reproduce"><a href="#Reproduce" class="headerlink" title="Reproduce"></a>Reproduce</h2><h3 id="專案建置"><a href="#專案建置" class="headerlink" title="專案建置"></a>專案建置</h3><p>先來試著模擬一下情境，為了更明確的知道其中的差異性，接下來會需要建置兩個專案（或是同一個專案改成 PWA）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">沒有 PWA</span></span><br><span class="line">dotnet new blazorwasm -n sample1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有 PWA</span></span><br><span class="line">dotnet new blazorwasm --pwa -n sample2</span><br></pre></td></tr></table></figure>

<p>到<a target="_blank" rel="noopener" href="https://www.dgpa.gov.tw/information?uid=41&pid=11397">人事行政局</a>下載 2024 年（民國 113 年）的行事曆，Excel 或是 PDF 都可以。<br>把檔案放到 wwwroot 底下，並且在 <code>Index.razor</code> 加上一個下載的連結。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@page &quot;/&quot;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">PageTitle</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">PageTitle</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">Welcome to your new app.</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 增加連結 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;113年辦公日曆表.pdf&quot;</span>&gt;</span>台灣 2024 年行事曆<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">SurveyPrompt</span> <span class="attr">Title</span>=<span class="string">&quot;How is Blazor working for you?&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>兩個專案都要做一次同樣的事情，並且用 <code>dotnet run</code> 來確認結果。</p>
<p><img src="/2023/10/02/blazor-wasm-pwa-static-file/sample1-local-run.png" alt="sample1-local-run"></p>
<p><img src="/2023/10/02/blazor-wasm-pwa-static-file/sample2-local-run.png" alt="sample2-local-run"></p>
<h3 id="模擬server"><a href="#模擬server" class="headerlink" title="模擬server"></a>模擬server</h3><p>接著要來模擬 deploy 到 server 後的情境，搭配使用 <a target="_blank" rel="noopener" href="https://ngrok.com/download">ngrok</a> 工具來實現 domain 的情境。<br>執行 <code>publish</code> 的指令，並且將輸出目錄指定為 <code>Release</code>。</p>
<blockquote>
<p>後面再來說為什麼要用這樣的模式</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet publish -c Release -o Release</span><br><span class="line">cd ./Release/wwwroot</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">透過 npm 套件 http-server 來架網站，如果是 windows 也可以用 IIS 來做到相同的事情</span></span><br><span class="line">npx http-server</span><br></pre></td></tr></table></figure>

<p><img src="/2023/10/02/blazor-wasm-pwa-static-file/npx-http-server.png" alt="npx-http-server"></p>
<p>先執行看看，確保網站能夠正確的呈現，接著要啟動 ngrok 來做 reverse proxy。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngrok http 8080</span><br></pre></td></tr></table></figure>

<p><img src="/2023/10/02/blazor-wasm-pwa-static-file/ngrok-run.png" alt="ngrok-run"></p>
<p>依序執行兩個專案，記得到 sample2 的時候要強制 refresh 才會吃到正確的內容。</p>
<blockquote>
<p>簡單一點也可以是關掉 ngrok 重新執行，會取得新的 domain</p>
</blockquote>
<p>用 domain 開啟 sample2 網站，試著點擊行事曆的連結，就會發現到系統竟然是重新載入頁面並且說找不到路由。</p>
<p><img src="/2023/10/02/blazor-wasm-pwa-static-file/pwa-issue-reproduce.png" alt="pwa-issue-reproduce"></p>
<p>##Root Cause</p>
<p>使用 localhost 開啟不管是不是 PWA 網站都沒事，只要用 Domain 開啟 PWA 就會發生路由問題，這到底是為什麼？</p>
<h3 id="PWA"><a href="#PWA" class="headerlink" title="PWA"></a>PWA</h3><p>按照前面來看最大問題點應該是 PWA 及 Domain，那就先來看看微軟如何<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/aspnet/core/blazor/progressive-web-app?view=aspnetcore-7.0&tabs=visual-studio-code">介紹 PWA</a>，並且搞清楚有沒有 PWA 的專案差異在哪。</p>
<ul>
<li>Working offline and loading instantly, independent of network speed.</li>
<li>Running in its own app window, not just a browser window.</li>
<li>Being launched from the host’s operating system start menu, dock, or home screen.</li>
<li>Receiving push notifications from a backend server, even while the user isn’t using the app.</li>
<li>Automatically updating in the background.</li>
</ul>
<p>跟一般的網頁最大差異有兩個，第一個是可以<strong>離線運作</strong>，第二個是可以<strong>安裝</strong>。<br>接著要來看看差異是什麼，從檔案的差異來看，可以看到 wwwroot 底下多了兩個檔案，<code>service-worker.js</code> 及 <code>service-worker.published.js</code>。</p>
<p><img src="/2023/10/02/blazor-wasm-pwa-static-file/pwa-wwwroot-diff.png" alt="pwa-wwwroot-diff"></p>
<p><code>csproj</code> 裡面的設定也有兩個地方不同，都是跟 <code>service-worker</code> 有關係。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">&quot;Microsoft.NET.Sdk.BlazorWebAssembly&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>net7.0<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Nullable</span>&gt;</span>enable<span class="tag">&lt;/<span class="name">Nullable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImplicitUsings</span>&gt;</span>enable<span class="tag">&lt;/<span class="name">ImplicitUsings</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 新增設定 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ServiceWorkerAssetsManifest</span>&gt;</span>service-worker-assets.js<span class="tag">&lt;/<span class="name">ServiceWorkerAssetsManifest</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Microsoft.AspNetCore.Components.WebAssembly&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;7.0.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">&quot;Microsoft.AspNetCore.Components.WebAssembly.DevServer&quot;</span> <span class="attr">Version</span>=<span class="string">&quot;7.0.0&quot;</span> <span class="attr">PrivateAssets</span>=<span class="string">&quot;all&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 新增設定 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ServiceWorker</span> <span class="attr">Include</span>=<span class="string">&quot;wwwroot\service-worker.js&quot;</span> <span class="attr">PublishedContent</span>=<span class="string">&quot;wwwroot\service-worker.published.js&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h3><p>既然重點會是在 Service Worker，那就來看看 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker">MDN 的介紹</a>。</p>
<blockquote>
<p><strong>Secure context:</strong> This feature is available only in <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts">secure contexts</a> (HTTPS), in some or all <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker#browser_compatibility">supporting browsers</a>.</p>
</blockquote>
<p>在最開頭就有說到，這個功能只會在 <code>HTTPS</code> 的環境下啟動，那這樣也能夠解釋為什麼 localhost 執行會是正常。<br>接著的問題就會是，為什麼會去走路由，而不是直接下載檔案。分別來看看兩個 <code>service-worker.*.js</code> 裡面做了什麼事情。</p>
<h4 id="service-worker-js"><a href="#service-worker-js" class="headerlink" title="service-worker.js"></a>service-worker.js</h4><p>在開發模式下，就會是這個檔案內容，可以看到的是根本沒有關於到 service worker 的功能，因此在開發階段怎麼樣的測試都會是正常的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In development, always fetch from the network and do not enable offline support.</span></span><br><span class="line"><span class="comment">// This is because caching would make development more difficult (changes would not</span></span><br><span class="line"><span class="comment">// be reflected on the first load after each change).</span></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function">() =&gt;</span> &#123; &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="service-woker-published-js"><a href="#service-woker-published-js" class="headerlink" title="service-woker.published.js"></a>service-woker.published.js</h4><p>發行過後，dotnet 編譯會將這個檔案內容取代原本的 <code>service-worker.js</code>，底下就試著去搞懂這段邏輯在做些什麼。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Caution! Be sure you understand the caveats before publishing an application with</span></span><br><span class="line"><span class="comment">// offline support. See https://aka.ms/blazor-offline-considerations</span></span><br><span class="line"></span><br><span class="line">self.importScripts(<span class="string">&#x27;./service-worker-assets.js&#x27;</span>);</span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;install&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> event.<span class="title function_">waitUntil</span>(<span class="title function_">onInstall</span>(event)));</span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;activate&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> event.<span class="title function_">waitUntil</span>(<span class="title function_">onActivate</span>(event)));</span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> event.<span class="title function_">respondWith</span>(<span class="title function_">onFetch</span>(event)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cacheNamePrefix = <span class="string">&#x27;offline-cache-&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> cacheName = <span class="string">`<span class="subst">$&#123;cacheNamePrefix&#125;</span><span class="subst">$&#123;self.assetsManifest.version&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> offlineAssetsInclude = [ <span class="regexp">/\.dll$/</span>, <span class="regexp">/\.pdb$/</span>, <span class="regexp">/\.wasm/</span>, <span class="regexp">/\.html/</span>, <span class="regexp">/\.js$/</span>, <span class="regexp">/\.json$/</span>, <span class="regexp">/\.css$/</span>, <span class="regexp">/\.woff$/</span>, <span class="regexp">/\.png$/</span>, <span class="regexp">/\.jpe?g$/</span>, <span class="regexp">/\.gif$/</span>, <span class="regexp">/\.ico$/</span>, <span class="regexp">/\.blat$/</span>, <span class="regexp">/\.dat$/</span> ];</span><br><span class="line"><span class="keyword">const</span> offlineAssetsExclude = [ <span class="regexp">/^service-worker\.js$/</span> ];</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onInstall</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Service worker: Install&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetch and cache all matching items from the assets manifest</span></span><br><span class="line">    <span class="keyword">const</span> assetsRequests = self.<span class="property">assetsManifest</span>.<span class="property">assets</span></span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">asset</span> =&gt;</span> offlineAssetsInclude.<span class="title function_">some</span>(<span class="function"><span class="params">pattern</span> =&gt;</span> pattern.<span class="title function_">test</span>(asset.<span class="property">url</span>)))</span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">asset</span> =&gt;</span> !offlineAssetsExclude.<span class="title function_">some</span>(<span class="function"><span class="params">pattern</span> =&gt;</span> pattern.<span class="title function_">test</span>(asset.<span class="property">url</span>)))</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">asset</span> =&gt;</span> <span class="keyword">new</span> <span class="title class_">Request</span>(asset.<span class="property">url</span>, &#123; <span class="attr">integrity</span>: asset.<span class="property">hash</span>, <span class="attr">cache</span>: <span class="string">&#x27;no-cache&#x27;</span> &#125;));</span><br><span class="line">    <span class="keyword">await</span> caches.<span class="title function_">open</span>(cacheName).<span class="title function_">then</span>(<span class="function"><span class="params">cache</span> =&gt;</span> cache.<span class="title function_">addAll</span>(assetsRequests));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onActivate</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Service worker: Activate&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delete unused caches</span></span><br><span class="line">    <span class="keyword">const</span> cacheKeys = <span class="keyword">await</span> caches.<span class="title function_">keys</span>();</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(cacheKeys</span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">key</span> =&gt;</span> key.<span class="title function_">startsWith</span>(cacheNamePrefix) &amp;&amp; key !== cacheName)</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">key</span> =&gt;</span> caches.<span class="title function_">delete</span>(key)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onFetch</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> cachedResponse = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">request</span>.<span class="property">method</span> === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// For all navigation requests, try to serve index.html from cache</span></span><br><span class="line">        <span class="comment">// If you need some URLs to be server-rendered, edit the following check to exclude those URLs</span></span><br><span class="line">        <span class="keyword">const</span> shouldServeIndexHtml = event.<span class="property">request</span>.<span class="property">mode</span> === <span class="string">&#x27;navigate&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> request = shouldServeIndexHtml ? <span class="string">&#x27;index.html&#x27;</span> : event.<span class="property">request</span>;</span><br><span class="line">        <span class="keyword">const</span> cache = <span class="keyword">await</span> caches.<span class="title function_">open</span>(cacheName);</span><br><span class="line">        cachedResponse = <span class="keyword">await</span> cache.<span class="title function_">match</span>(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cachedResponse || <span class="title function_">fetch</span>(event.<span class="property">request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，看到 import  一個額外的檔案 <code>service-worker-assets.js</code>，但在 source code 裡面沒找到，可以先推測是編譯的時候才產生。往下看到 <code>offlineAssetsInclude</code> 這個變數，宣告各種常見的靜態檔案，像是圖片或是字形檔；<code>offlineAssetsExclude</code> 變數則是把 <code>service-worker.js</code> 宣告為不可快取，畢竟 service-worker 一旦被快取，那 server 有更新的話就會沒跟上。<br>底下的三個方法，就是決定哪些請求是可以直接走快取，哪些則是要去跟 server 做請求。</p>
<h5 id="onInstall"><a href="#onInstall" class="headerlink" title="onInstall"></a>onInstall</h5><p>當 service worker 安裝的時候，會把 <code>service-worker-assets.js</code> 檔案中設定且符合 <code>offlineAssetsInclude</code> 的檔案加入快取清單。</p>
<h5 id="onActivate"><a href="#onActivate" class="headerlink" title="onActivate"></a>onActivate</h5><p>清除掉已經無效的快取。</p>
<h5 id="onFetch"><a href="#onFetch" class="headerlink" title="onFetch"></a>onFetch</h5><p>請求是 GET 的情況下，會檢查請求路徑是否符合快取的檔案，如果是的話則直接取得檔案；其他則是直接跟 server 做請求。</p>
<h4 id="service-worker-assets-js"><a href="#service-worker-assets-js" class="headerlink" title="service-worker-assets.js"></a>service-worker-assets.js</h4><p>如前面所說，這個檔案是編譯才會有的，在 sample2&#x2F;Release 資料夾找到該檔案。<br>檔案結構很簡單，就是 <code>assetsManifest</code> 這個物件中有兩個屬性 <code>assets</code> 及 <code>version</code>。可以在 assets 中看到 wwwroot 底下的檔案幾乎都有被放進去，唯獨我們這次的目標 <code>113年辦公日曆表.pdf</code> 並沒有在清單中，依照前面的 <code>onFetch</code> 邏輯，這時候自然會直接跟 server 做請求也就是會走路由的行為，並且回報路由錯誤。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="property">assetsManifest</span> = &#123;</span><br><span class="line">  <span class="string">&quot;assets&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-gMMhXf930MHxSiJZcjP4DGT41x\/\/4UluuuaVRM2SZIk=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/blazor.webassembly.js&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-JmMF+3r0RjsO0yYBfDP8Pq2ahxBSJHFu7mZNB9lqLsw=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/dotnet.7.0.7.lvcvwsp4ai.js&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-E5nX3n\/\/2kvaYqbQ2VjaS4BXnlnEYW3gU0pr58g11a4=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/dotnet.timezones.blat&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-q7mSjRyJTT10PpQnSxO1TZAwei3YpzD76Akn6E57GTU=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/dotnet.wasm&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-SZLtQnRc0JkwqHab0VUVP7T3uBPSeYzxzDnpxPpUnHk=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/icudt_CJK.dat&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-8fItetYY8kQ0ww6oxwTLiT3oXlBwHKumbeP2pRF4yTc=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/icudt_EFIGS.dat&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-L7sV7NEYP37\/Qr2FPCePo5cJqRgTXRwGHuwF5Q+0Nfs=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/icudt_no_CJK.dat&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-tO5O5YzMTVSaKBboxAqezOQL9ewmupzV2JrB5Rkc8a4=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/icudt.dat&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-1+1o3tb7DjOeVSY3fkfvtXGL8VrnvSojyRwqtP0L7Ms=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/blazor.boot.json&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-h3b\/h8RHSoCJ0Sjd6yf8VfoKk4va5PcIDZr\/COzisyk=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.AspNetCore.Components.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-M4eAEQfmoZY9Hoblq1fGL6MCo\/dlBEjHR0mgArTQH1U=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.AspNetCore.Components.Web.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-tpvXX7M\/LEGTEvYWgu8LEXMhjtjwoFAKuxUiqdpIH2E=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.AspNetCore.Components.WebAssembly.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-X\/f4fDl2cuIRXeWHhK\/f2UqQbFioD+RU4a4CEh0zrrQ=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.Configuration.Abstractions.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-DBOKSPriP2JDxVbbWrLXyD3K4\/x3RBifNBWk\/q1I39M=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.Configuration.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-Q5AqJneA2TZnzC0IYzBx6j\/tHRhWAeMbpH3BsV7KgWg=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.Configuration.Json.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-7ni+nO8H2QxkXyRXRureFzJc0Tr5aT45TAYcdlgpmwQ=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.DependencyInjection.Abstractions.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-qi0kE7rp0kdsNqdL6DyPZEeimjUGvcLT4iWQX0YnRus=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.DependencyInjection.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-qZdDWEYBno4I8vPywu9Fyn5LLwSVquG8Y7JzRiWgFEA=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.Logging.Abstractions.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-RJE660TEC1wm3MyL1EXQfTQB1qK+JWy1efVUxI8nNUo=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.Logging.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-QqyagFWSuupxyjIZM2m\/ovuMuvYHTCjR2+BRNiUT4WA=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.Options.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-eXvGx2jcjpTPEJoAHBsW\/VuMPbNyyU+AsuhPmkzSSRY=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.Extensions.Primitives.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-O2v\/TEzGxRkJx2s8BIzjplzaBZGIjAEU8QLVvMi29Pk=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.JSInterop.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-6yDYSBiy48fNaYJlqK10GSN72A6Vsu3i\/6v3Lq7kL2E=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/Microsoft.JSInterop.WebAssembly.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-QV+RIj4HlZ0kGZ2\/Z7+3KCHKBuuBWY4sQq+3Tuu4G+g=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/sample2.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-M5QNIjWTWuKn8+IKAVWEdjk7OB2HhnQd\/jmEz0YFfTQ=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Collections.Concurrent.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-yNgdj0HVTyDrEY9f0Y9on7p6DfvN2\/Av1guJChKeYMI=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Collections.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-aF2ysxa8maJxS6cn0NMTkjFFkQQ2EGqlsZXcjbHKHAo=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.ComponentModel.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-UX+onNe4XrzDF4D77LZbU62NxGG584NgorjUWc44IuA=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Memory.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-YQg8IghMY8pX7hWuiYAwk5ZUC0AMH9ocXIpoR0v5Pnw=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Net.Http.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-wMwpwqN\/4NoGNubv9OAPyQ5wHGDqBfVwyXU2GnrGxqw=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Net.Http.Json.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-XhaOHBnuuBTlmq9Ql4BNsyJMofu2PGm1jfMsb5SzJFE=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Net.Primitives.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-YgI1h1OAlRlFjYLxihDndQElNJJQPfSqjlwZ\/Se\/DP8=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Private.CoreLib.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-xSSJ+9XXUxenECnwe8bjHecAqYqZ+JPHthO9FXwOj7Y=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Private.Uri.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-P11SLO9jG6JCbfAAsZqym+ASgvyFhaPQdkrW3sqQsJ8=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Runtime.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-JI4+guYHKj5fqYDpsIHyPDahxGL0HaBf6diAoZ7NftI=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Runtime.InteropServices.JavaScript.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-d2KyUrvcwKoW1p2fFbn+9S8MAFFWpDvA\/McxgmUYZq0=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Text.Encodings.Web.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-G3mqwxP7plT8QPbjMqz87LfxB3tIrwVAi8iOMYG5xAA=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;_framework\/System.Text.Json.dll&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-hTtBBebB8GK8lA\/8LsOBK\/CLkHvOrPL5vXpZRxMUqmA=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;sample2.styles.css&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-uhotZszkBLq\/V8xt8UtpU6lGHEIqbqLsFUVGyelV2TU=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/app.css&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-z8OR40MowJ8GgK6P89Y+hiJK5+cclzFHzLhFQLL92bg=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/bootstrap\/bootstrap.min.css&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-gBwg2tmA0Ci2u54gMF1jNCVku6vznarkLS6D76htNNQ=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/bootstrap\/bootstrap.min.css.map&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-jA4J4h\/k76zVxbFKEaWwFKJccmO0voOQ1DbUW+5YNlI=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/FONT-LICENSE&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-BJ\/G+e+y7bQdrYkS2RBTyNfBHpA9IuGaPmf9htub5MQ=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/font\/css\/open-iconic-bootstrap.min.css&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-OK3poGPgzKI2NzNgP07XMbJa3Dz6USoUh\/chSkSvQpc=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/font\/fonts\/open-iconic.eot&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-sDUtuZAEzWZyv\/U1xl\/9D3ehyU69JE+FvAcu5HQ+\/a0=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/font\/fonts\/open-iconic.otf&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-+P1oQ5jPzOVJGC52E1oxGXIXxxCyMlqy6A9cNxGYzVk=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/font\/fonts\/open-iconic.svg&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-p+RP8CV3vRK1YbIkNzq3rPo1jyETPnR07ULb+HVYL8w=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/font\/fonts\/open-iconic.ttf&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-cZPqVlRJfSNW0KaQ4+UPOXZ\/v\/QzXlejRDwUNdZIofI=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/font\/fonts\/open-iconic.woff&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-aF5g\/izareSj02F3MPSoTGNbcMBl9nmZKDe04zjU\/ss=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/ICON-LICENSE&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-waukoLqsiIAw\/nXpsKkTHnhImmcPijcBEd2lzqzJNN0=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;css\/open-iconic\/README.md&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-4mWsDy3aHl36ZbGt8zByK7Pvd4kRUoNgTYzRnwmPHwg=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;favicon.png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-DbpQaq68ZSb5IoPosBErM1QWBfsbTxpJqhU0REi6wP4=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;icon-192.png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-oEo6d+KqX5fjxTiZk\/w9NB3Mi0+ycS5yLwCKwr4IkbA=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;icon-512.png&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-Dg2uj5FTONMutQFA\/bavi4qjP\/n7cs5KSlHxzSeUlvU=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;index.html&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-ktQ0GNo4y\/NR+Jokrj566okRN7YiZQ\/64bW4b4Oyg9Y=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;manifest.json&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-enKgCMkYmCpfEcmg6Annbmc40VZ\/A6aYYSQjZfVn2cU=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;sample-data\/weather.json&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;fRK4QZQj&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Fix"><a href="#Fix" class="headerlink" title="Fix"></a>Fix</h2><p>前面講了那麼多就是為了要搞懂原理，接下來就是修正問題，<code>service-worker-assets.js</code> 是編譯才產生，因此需要想辦法讓我們新增的檔案能夠被加入，在<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/aspnet/core/blazor/progressive-web-app?view=aspnetcore-7.0&tabs=visual-studio#control-asset-caching">微軟的文件</a>中其實有提到，如何增加靜態檔案的快取。<br>在 <code>csproj</code> 中設定 <code>ServiceWorkerAssetsManifestItem</code> 檔案以及輸出的路徑。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ServiceWorkerAssetsManifestItem</span> <span class="attr">Include</span>=<span class="string">&quot;wwwroot\113年辦公日曆表.pdf&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">RelativePath</span>=<span class="string">&quot;wwwroot\113年辦公日曆表.pdf&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">AssetUrl</span>=<span class="string">&quot;wwwroot\113年辦公日曆表.pdf&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>設定後，執行 <code>publish</code> 的指令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">習慣先清除，避免有不預期的檔案影響</span></span><br><span class="line">rm -rf .\Release</span><br><span class="line">dotnet publish -c Release -o Release</span><br></pre></td></tr></table></figure>

<p>執行指令不用急著去把系統跑起來，可以先看看 <code>service-worker-assets.js</code> 有沒有如預期地把檔案加進去，使用搜尋的方式找 <code>pdf</code> 字串，就能找到檔案如預期的被加入了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="property">assetsManifest</span> = &#123;</span><br><span class="line">  <span class="string">&quot;assets&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;hash&quot;</span>: <span class="string">&quot;sha256-uXu0r9IYHvtbwnfPL5kHgiHaOTGk6IfnbpfJDHzN3ZU=&quot;</span>,</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: <span class="string">&quot;113年辦公日曆表.pdf&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;Ku+lgBpy&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接著使用前面架網站的方式來啟動，用瀏覽器的方式來看是否可以正常下載；可以發現還是失敗，偵錯 <code>onFetch</code> 看到 <code>request.mode</code> 是 <code>navigate</code>，因此會去走一般的請求。</p>
<h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>調整 <code>onFetch</code> 的邏輯，讓 pdf 副檔名可以走快取的邏輯。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onFetch</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> cachedResponse = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">request</span>.<span class="property">method</span> === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 調整這邊的邏輯</span></span><br><span class="line">        <span class="keyword">const</span> shouldServeIndexHtml = event.<span class="property">request</span>.<span class="property">mode</span> === <span class="string">&#x27;navigate&#x27;</span> &amp;&amp; !event.<span class="property">request</span>.<span class="property">url</span>.<span class="title function_">endsWith</span>(<span class="string">&#x27;pdf&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> request = shouldServeIndexHtml ? <span class="string">&#x27;index.html&#x27;</span> : event.<span class="property">request</span>;</span><br><span class="line">        <span class="keyword">const</span> cache = <span class="keyword">await</span> caches.<span class="title function_">open</span>(cacheName);</span><br><span class="line">        cachedResponse = <span class="keyword">await</span> cache.<span class="title function_">match</span>(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cachedResponse || <span class="title function_">fetch</span>(event.<span class="property">request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果有多個檔案的話，建議用一個資料夾會比較好控制</p>
</blockquote>
<h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>前面的問題在 Dotnet 8 有被調整過，可以參考這個 <a target="_blank" rel="noopener" href="https://github.com/dotnet/aspnetcore/issues/40678">github issue</a>，基本上就是有在 assets 控制下的就會採用快取，底下是 Dotnet 8 部分修正的內容。</p>
<blockquote>
<p>個人覺得這個解法才是正確的</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> base = <span class="string">&quot;/&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> baseUrl = <span class="keyword">new</span> <span class="title function_">URL</span>(base, self.<span class="property">origin</span>);</span><br><span class="line"><span class="keyword">const</span> manifestUrlList = self.<span class="property">assetsManifest</span>.<span class="property">assets</span>.<span class="title function_">map</span>(<span class="function"><span class="params">asset</span> =&gt;</span> <span class="keyword">new</span> <span class="title function_">URL</span>(asset.<span class="property">url</span>, baseUrl).<span class="property">href</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onFetch</span>(<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> cachedResponse = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">request</span>.<span class="property">method</span> === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// For all navigation requests, try to serve index.html from cache,</span></span><br><span class="line">        <span class="comment">// unless that request is for an offline resource.</span></span><br><span class="line">        <span class="comment">// If you need some URLs to be server-rendered, edit the following check to exclude those URLs</span></span><br><span class="line">        <span class="keyword">const</span> shouldServeIndexHtml = event.<span class="property">request</span>.<span class="property">mode</span> === <span class="string">&#x27;navigate&#x27;</span></span><br><span class="line">            &amp;&amp; !manifestUrlList.<span class="title function_">some</span>(<span class="function"><span class="params">url</span> =&gt;</span> url === event.<span class="property">request</span>.<span class="property">url</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> request = shouldServeIndexHtml ? <span class="string">&#x27;index.html&#x27;</span> : event.<span class="property">request</span>;</span><br><span class="line">        <span class="keyword">const</span> cache = <span class="keyword">await</span> caches.<span class="title function_">open</span>(cacheName);</span><br><span class="line">        cachedResponse = <span class="keyword">await</span> cache.<span class="title function_">match</span>(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cachedResponse || <span class="title function_">fetch</span>(event.<span class="property">request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解法三"><a href="#解法三" class="headerlink" title="解法三"></a>解法三</h3><p>這個解法應該是最簡單的，採用標準 html 的作法，也就是加上 <code>download</code> 的屬性。</p>
<blockquote>
<p>murmur: 雖然這是標準但就算沒有加也不應該去走路由阿</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;113年辦公日曆表.pdf&quot;</span> <span class="attr">download</span>&gt;</span>台灣 2024 年行事曆<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/aspnet/core/blazor/progressive-web-app?view=aspnetcore-7.0&tabs=visual-studio#control-asset-caching">ASP.NET Core Blazor Progressive Web Application (PWA) | Microsoft Learn</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/static-files?view=aspnetcore-7.0&viewFallbackFrom=aspnetcore-2.1&tabs=aspnetcore2x">Static files in ASP.NET Core | Microsoft Learn</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-7.0&tabs=linux-ubuntu#use-a-reverse-proxy-server">Host ASP.NET Core on Linux with Nginx | Microsoft Learn</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker">ServiceWorker - Web APIs | MDN (mozilla.org)</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/a"><a>: The Anchor element - HTML: HyperText Markup Language | MDN (mozilla.org)</a></li>
</ul>

		</div>
		
	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/2023/12/15/nginx-logrotate-windows/" rel="prev"  title="[nginx] 運行於 windows 底下設定 log 的備份機制">
						[nginx] 運行於 windows 底下設定 log 的備份機制 
					</a></span>
				
				
					<span class="art-item-right">next：<a href="/2023/08/07/remix-wget-mirror-to-github-page/" rel="next"  title="Remix 佈署到 Github Pages">
						Remix 佈署到 Github Pages
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
	 
		<section id="comments">
			<script src="https://giscus.app/client.js"
				data-repo="jiaming0708/jiaming0708.github.io"
				data-repo-id="MDEwOlJlcG9zaXRvcnk4Mjc2OTM4OQ=="
				data-category="Q&amp;A"
				data-category-id="DIC_kwDOBO717c4B_0N9"
				data-mapping="title"
				data-reactions-enabled="1"
				data-theme="light"
				crossorigin="anonymous"
				async>
			</script>
		</section>
	
</article>
<script>
	window.subData = {
		title: '[Blazor] PWA 靜態檔案問題',
		tools: true
	}
</script>

      </div>
      
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/jiaming0708" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/Secret_GoGo" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a target="_blank" rel="noopener" href='https://github.com/jiaming0708/hexo-theme-material-flow' class="codename">MaterialFlow+</a> designed by <a href="https://jiaming0708.github.io" target="_blank">Jimmy Ho</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/node-waves/0.7.6/waves.min.js'></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/scrollReveal.js/4.0.9/scrollreveal.min.js"></script>

<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
</body>
</html>
