<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>[Blazor] 元件測試 - mock | Secret Note</title>
  <meta name="description" content="記錄一些自己記不住的東西" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="Secret Note" type="application/atom+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前一篇 [Blazor] 元件測試 - 基礎篇 中已經介紹過基本的測試，今天要來介紹的是 Mock 的應用。  使用上次的 repo 接續操作">
<meta property="og:type" content="article">
<meta property="og:title" content="[Blazor] 元件測試 - mock">
<meta property="og:url" content="http://jiaming0708.github.io/2022/01/21/blazor-testing-mock/index.html">
<meta property="og:site_name" content="Secret Note">
<meta property="og:description" content="前一篇 [Blazor] 元件測試 - 基礎篇 中已經介紹過基本的測試，今天要來介紹的是 Mock 的應用。  使用上次的 repo 接續操作">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2022-01-21T07:40:56.000Z">
<meta property="article:modified_time" content="2023-02-20T14:24:07.226Z">
<meta property="article:author" content="Jimmy Ho">
<meta property="article:tag" content="Testing">
<meta property="article:tag" content="Blazor">
<meta name="twitter:card" content="summary">
    
  <link href="//fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="preload">
  <link href="//fonts.googleapis.com/css?family=Roboto+Mono" rel="preload">
  <link href='//cdnjs.cloudflare.com/ajax/libs/node-waves/0.7.6/waves.min.css' rel='stylesheet'>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5LXTGJNLYY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-5LXTGJNLYY');
    </script>
  
  
    <script data-ad-client="ca-pub-6806360411033447" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Secret Note | 機密檔案
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-blazor-testing-mock"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2022/01/21/blazor-testing-mock/">
    	[Blazor] 元件測試 - mock
    </a>
  </h2>
	<time>
	  1月 21, 2022
	</time>
	
    
    <div class='cats'>
        <a href="/categories/Frontend/">Frontend</a>, <a href="/categories/Frontend/Blazor/">Blazor</a>
    </div>
    
        <span class="readtime">32 mins.</span>
    

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FetchData-%E9%A0%81%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">FetchData 頁面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mock-HttpClient"><span class="toc-number">1.1.</span> <span class="toc-text">Mock HttpClient</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mock-API"><span class="toc-number">1.2.</span> <span class="toc-text">mock API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Index-%E9%A0%81%E9%9D%A2"><span class="toc-number">2.</span> <span class="toc-text">Index 頁面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mock-Component"><span class="toc-number">2.1.</span> <span class="toc-text">Mock Component</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mock-content"><span class="toc-number">2.2.</span> <span class="toc-text">Mock content</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mock-content-with-parameter"><span class="toc-number">2.3.</span> <span class="toc-text">Mock content with parameter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%A5%97%E4%BB%B6"><span class="toc-number">2.4.</span> <span class="toc-text">使用第三方套件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B8%BD%E7%B5%90"><span class="toc-number">3.</span> <span class="toc-text">總結</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol></section>
	
	<section class="article typo">
	  
	  <div class="article-tags tags">
      
        <a href="/tags/Testing/">Testing</a>
      
        <a href="/tags/Blazor/">Blazor</a>
      
	  </div>
		
  	<div class="article-entry" itemprop="articleBody">
			<p>前一篇 <a href="/2021/12/23/blazor-testing-basic/" title="[Blazor] 元件測試 - 基礎篇">[Blazor] 元件測試 - 基礎篇</a> 中已經介紹過基本的測試，今天要來介紹的是 <code>Mock</code> 的應用。</p>
<blockquote>
<p>使用上次的 <a target="_blank" rel="noopener" href="https://github.com/jiaming0708/blazor-testing-demo">repo</a> 接續操作</p>
</blockquote>
<span id="more"></span>

<h1 id="FetchData-頁面"><a href="#FetchData-頁面" class="headerlink" title="FetchData 頁面"></a>FetchData 頁面</h1><p>開啟 <code>Pages</code> 中的 <code>FetchData.razor</code> 這個元件，可以注意到 <code>OnInitializedAsync</code> 的部份，是透過 <code>HttpClient</code> 打 API 取得資料回來呈現。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">@page &quot;/fetchdata&quot;</span><br><span class="line">@inject HttpClient Http</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">PageTitle</span>&gt;</span>Weather forecast<span class="tag">&lt;/<span class="name">PageTitle</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Weather forecast<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This component demonstrates fetching data from the server.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@if (forecasts == null)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>Date<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>Temp. (C)<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>Temp. (F)<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>Summary<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">            @foreach (var forecast in forecasts)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>@forecast.Date.ToShortDateString()<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>@forecast.TemperatureC<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>@forecast.TemperatureF<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>@forecast.Summary<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@code &#123;</span><br><span class="line">    private WeatherForecast[]? forecasts;</span><br><span class="line"></span><br><span class="line">    protected override async Task OnInitializedAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        forecasts = await Http.GetFromJsonAsync&lt;WeatherForecast[]&gt;(&quot;sample-data/weather.json&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class WeatherForecast</span><br><span class="line">    &#123;</span><br><span class="line">        public DateTime Date &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">        public int TemperatureC &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">        public string? Summary &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">        public int TemperatureF =&gt; 32 + (int)(TemperatureC / 0.5556);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Mock-HttpClient"><a href="#Mock-HttpClient" class="headerlink" title="Mock HttpClient"></a>Mock HttpClient</h2><p>在測試專案中，新增一個檔案 <code>FetchDataTest.cs</code>，並加上一個測試案例直接針對 FetchData 這個元件的輸出來看看結果。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RenderWithoutResponse</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;FetchData&gt;();</span><br><span class="line">  Console.WriteLine(comp.Markup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>應該會看到測試失敗，原因就是在 init 時有使用到 HttpClient。</p>
<blockquote>
<p>This test requires a HttpClient to be supplied, because the component under test invokes the HttpClient during the test. The request that was sent is contained within the ‘Request’ attribute of this exception. Guidance on mocking the HttpClient is available on bUnit’s website.</p>
</blockquote>
<p>要對 HttpClient 進行 mock 的話，還需要安裝另外一個 library <strong>RichardSzalay.MockHttp</strong>，打開 Nuget 管理並且加入這個套件到測試專案中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PM&gt; <span class="built_in">Install-Package</span> RichardSzalay.MockHttp</span><br></pre></td></tr></table></figure>

<p>建立一個檔案 <code>MockHttpClientBunitHelpers</code>  來實作兩個功能</p>
<ul>
<li>註冊 HttpClient 到 Service</li>
<li>Response 的介面</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http.Headers;</span><br><span class="line"><span class="keyword">using</span> System.Text.Json;</span><br><span class="line"><span class="keyword">using</span> Bunit;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> RichardSzalay.MockHttp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MockHttpClientBunitHelpers</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MockHttpMessageHandler <span class="title">AddMockHttpClient</span>(<span class="params"><span class="keyword">this</span> TestServiceProvider services</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> mockHttpHandler = <span class="keyword">new</span> MockHttpMessageHandler();</span><br><span class="line">    <span class="keyword">var</span> httpClient = mockHttpHandler.ToHttpClient();</span><br><span class="line">    httpClient.BaseAddress = <span class="keyword">new</span> Uri(<span class="string">&quot;http://localhost&quot;</span>);</span><br><span class="line">    services.AddSingleton&lt;HttpClient&gt;(httpClient);</span><br><span class="line">    <span class="keyword">return</span> mockHttpHandler;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MockedRequest <span class="title">RespondJson</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> MockedRequest request, T content</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    request.Respond(req =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">var</span> response = <span class="keyword">new</span> HttpResponseMessage(HttpStatusCode.OK);</span><br><span class="line">      response.Content = <span class="keyword">new</span> StringContent(JsonSerializer.Serialize(content));</span><br><span class="line">      response.Content.Headers.ContentType = <span class="keyword">new</span> MediaTypeHeaderValue(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> response;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MockedRequest <span class="title">RespondJson</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> MockedRequest request, Func&lt;T&gt; contentProvider</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    request.Respond(req =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">var</span> response = <span class="keyword">new</span> HttpResponseMessage(HttpStatusCode.OK);</span><br><span class="line">      response.Content = <span class="keyword">new</span> StringContent(JsonSerializer.Serialize(contentProvider()));</span><br><span class="line">      response.Content.Headers.ContentType = <span class="keyword">new</span> MediaTypeHeaderValue(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> response;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著來修改剛剛的測試案例，在 Service 註冊 HttpClient 就可以讓測試順利通過，並且看到結果包含著 <strong>Loading…</strong> 的字串。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RenderWithoutResponse</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  <span class="keyword">var</span> mock = ctx.Services.AddMockHttpClient();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;FetchData&gt;();</span><br><span class="line">  StringAssert.Contains(<span class="string">&quot;Loading...&quot;</span>, comp.Markup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mock-API"><a href="#mock-API" class="headerlink" title="mock API"></a>mock API</h2><p>使用 mock 物件提供的 When 以及剛剛所寫的 RespondJson 方法，來處理資料。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RenderWithoutResponse</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  <span class="keyword">var</span> mock = ctx.Services.AddMockHttpClient();</span><br><span class="line">  mock.When(<span class="string">&quot;/sample-data/weather.json&quot;</span>).RespondJson(<span class="keyword">new</span> List&lt;FetchData.WeatherForecast&gt;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">new</span>() &#123;Date = <span class="keyword">new</span> DateTime(<span class="number">2022</span>, <span class="number">01</span>, <span class="number">20</span>), TemperatureC = <span class="number">15</span>, Summary = <span class="string">&quot;first data&quot;</span>&#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;FetchData&gt;();</span><br><span class="line">  StringAssert.Contains(<span class="string">&quot;Loading...&quot;</span>, comp.Markup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以發現這樣怎麼還是沒重新 render 拿到新的 html 結構，因為是使用非同步的方法取得資料，因此測試也需要使用非同步的方式。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RenderMockResponse</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  <span class="keyword">var</span> mock = ctx.Services.AddMockHttpClient();</span><br><span class="line">  mock.When(<span class="string">&quot;/sample-data/weather.json&quot;</span>).RespondJson(<span class="keyword">new</span> List&lt;FetchData.WeatherForecast&gt;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">new</span>() &#123;Date = <span class="keyword">new</span> DateTime(<span class="number">2022</span>, <span class="number">01</span>, <span class="number">20</span>), TemperatureC = <span class="number">15</span>, Summary = <span class="string">&quot;first data&quot;</span>&#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;FetchData&gt;();</span><br><span class="line">  comp.WaitForAssertion(() =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">    Assert.IsNotNull(comp.Find(<span class="string">&quot;.table&quot;</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了使用 <code>WaitForAssertion</code> 也可以採用另一種等待狀態變更 <code>WaitForState</code> 的作法，後面就能變回同步的狀態。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RenderMockResponse_WaitState</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  <span class="keyword">var</span> mock = ctx.Services.AddMockHttpClient();</span><br><span class="line">  mock.When(<span class="string">&quot;/sample-data/weather.json&quot;</span>).RespondJson(<span class="keyword">new</span> List&lt;FetchData.WeatherForecast&gt;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">new</span>() &#123;Date = <span class="keyword">new</span> DateTime(<span class="number">2022</span>, <span class="number">01</span>, <span class="number">20</span>), TemperatureC = <span class="number">15</span>, Summary = <span class="string">&quot;first data&quot;</span>&#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;FetchData&gt;();</span><br><span class="line">  comp.WaitForState(() =&gt; !comp.Markup.Contains(<span class="string">&quot;Loading...&quot;</span>));</span><br><span class="line">  Assert.IsNotNull(comp.Find(<span class="string">&quot;.table&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Index-頁面"><a href="#Index-頁面" class="headerlink" title="Index 頁面"></a>Index 頁面</h1><p>看完 Mock HttpClient 的作法後，接著要來做 Mock Component，有時候我們可以假設 Child component 的行為都是正確的，把測試主力放在自己身上，這時候就會需要這個技巧。</p>
<p>開啟 Pages 中 <code>Index.razor</code> 的內容，裡面使用到 <code>SurveyPrompt</code> 元件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@page &quot;/&quot;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">PageTitle</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">PageTitle</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">Welcome to your new app.</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">SurveyPrompt</span> <span class="attr">Title</span>=<span class="string">&quot;How is Blazor working for you?&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Mock-Component"><a href="#Mock-Component" class="headerlink" title="Mock Component"></a>Mock Component</h2><p>在測試專案中，新增檔案 <code>IndexTest.cs</code>。<br>在 ComponntFactories 加上要 mock 的元件，先試著 mock SurveyPrompt 看輸出內容，就可以發現那個元件的部份是完全空白。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MockChildComp</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  ctx.ComponentFactories.AddStub&lt;SurveyPrompt&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;Index&gt;();</span><br><span class="line">  Console.WriteLine(comp.Markup);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">&lt;h1&gt;Hello, world!&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Welcome to your new app.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以使用 <code>IRenderedComponent.HasComponent&lt;T&gt;()</code> 檢查元件是否有存在，將測試案例調整一下。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MockChildComp</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  ctx.ComponentFactories.AddStub&lt;SurveyPrompt&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;Index&gt;();</span><br><span class="line">  Assert.False(comp.HasComponent&lt;SurveyPrompt&gt;());</span><br><span class="line">  Assert.True(comp.HasComponent&lt;Stub&lt;SurveyPrompt&gt;&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Mock-content"><a href="#Mock-content" class="headerlink" title="Mock content"></a>Mock content</h2><p>剛剛的測試是沒有任何內容，如果想要自訂內容的話，可以在 <code>AddStub&lt;T&gt;(&quot;xxxx&quot;)</code> 中放入字串。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MockChildCompContent</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  <span class="keyword">var</span> content = <span class="string">&quot;&lt;div&gt;Mock SurveyPrompt&lt;/div&gt;&quot;</span>;</span><br><span class="line">  ctx.ComponentFactories.AddStub&lt;SurveyPrompt&gt;(content);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;Index&gt;();</span><br><span class="line">  StringAssert.Contains(content, comp.Markup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Mock-content-with-parameter"><a href="#Mock-content-with-parameter" class="headerlink" title="Mock content with parameter"></a>Mock content with parameter</h2><p>除了寫死的內容以外，也能夠支援傳遞參數的方法，在 AddStub 的方法內改用函式的作法，來取得並輸出參數。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MockChildCompContentWithParameter</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  ctx.ComponentFactories.AddStub&lt;SurveyPrompt&gt;(paras =&gt; <span class="string">$&quot;&lt;div&gt;<span class="subst">&#123;paras.Get(x =&gt; x.Title)&#125;</span>&lt;/div&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;Index&gt;();</span><br><span class="line">  StringAssert.Contains(<span class="string">&quot;How is Blazor working for you?&quot;</span>, comp.Markup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用第三方套件"><a href="#使用第三方套件" class="headerlink" title="使用第三方套件"></a>使用第三方套件</h2><p>除了 bUnit 的這種作法外，也可以使用第三方的 mock 套件，像是 <code>MOQ</code> 及 <code>NSubtitute</code>。作法跟上面的類似，將 <code>AddStub&lt;T&gt;()</code> 改為 <code>Add&lt;T&gt;(mock object)</code> 。</p>
<p>打開 Nuget 管理將 <code>MOQ</code> 這個套件加入到測試專案中，這邊將使用 MOQ 做範例。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PM&gt; <span class="built_in">Install-Package</span> MOQ</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MockComponentByMOQ</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">using</span> <span class="keyword">var</span> ctx = <span class="keyword">new</span> Bunit.TestContext();</span><br><span class="line">  <span class="keyword">var</span> mockComp = <span class="keyword">new</span> Mock&lt;SurveyPrompt&gt;();</span><br><span class="line">  ctx.ComponentFactories.Add(mockComp.Object);</span><br><span class="line">  <span class="comment">// 另一種寫法</span></span><br><span class="line">  <span class="comment">// ctx.ComponentFactories.Add(() =&gt; Mock.Of&lt;SurveyPrompt&gt;());</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> comp = ctx.RenderComponent&lt;Index&gt;();</span><br><span class="line">  <span class="keyword">var</span> actualComp = comp.FindComponent&lt;SurveyPrompt&gt;();</span><br><span class="line">  Assert.AreSame(mockComp.Object, actualComp.Instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h1><p>今天介紹了 HttpClient 及 Component 的 mock 方法，個人覺得還要另外採用第三方套件來做 Mock 是蠻麻煩的，但官方目前的態度就是這樣，bUnit 不去依賴第三方套件。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jiaming0708/blazor-testing-demo">範例程式</a> 也放在 github 上，如果有需要也可以按照 commit 的步驟來跟著操作學習。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://bunit.dev/docs/providing-input/substituting-components.html?tabs=moq">mocking component</a></li>
<li><a target="_blank" rel="noopener" href="https://bunit.dev/docs/test-doubles/mocking-httpclient.html">mocking HttpClient</a></li>
</ul>

		</div>
		
	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/2022/01/28/blazor-testing-service/" rel="prev"  title="[Blazor] 元件測試 - Service">
						[Blazor] 元件測試 - Service 
					</a></span>
				
				
					<span class="art-item-right">next：<a href="/2021/12/29/dll-publish-nuget/" rel="next"  title="將獨立的 dll 打包發佈到 nuget server">
						將獨立的 dll 打包發佈到 nuget server
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
	 
		<section id="comments">
			<script src="https://giscus.app/client.js"
				data-repo="jiaming0708/jiaming0708.github.io"
				data-repo-id="MDEwOlJlcG9zaXRvcnk4Mjc2OTM4OQ=="
				data-category="Q&amp;A"
				data-category-id="DIC_kwDOBO717c4B_0N9"
				data-mapping="title"
				data-reactions-enabled="1"
				data-theme="light"
				crossorigin="anonymous"
				async>
			</script>
		</section>
	
</article>
<script>
	window.subData = {
		title: '[Blazor] 元件測試 - mock',
		tools: true
	}
</script>

      </div>
      
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/jiaming0708" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/Secret_GoGo" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a target="_blank" rel="noopener" href='https://github.com/jiaming0708/hexo-theme-material-flow' class="codename">MaterialFlow+</a> designed by <a href="https://jiaming0708.github.io" target="_blank">Jimmy Ho</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/node-waves/0.7.6/waves.min.js'></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/scrollReveal.js/4.0.9/scrollreveal.min.js"></script>

<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
</body>
</html>
