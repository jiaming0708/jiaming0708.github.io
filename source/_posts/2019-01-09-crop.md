---
title: '[cropç³»åˆ—] 5 å®Œæ•´å¯¦ä½œ'
date: 2019-01-09 21:43:55
categories:
- Frontend
- React
tags:
- React
- crop
---

ç³»åˆ—æ–‡çµ‚æ–¼è¦ä¾†åˆ°æœ€çµ‚ç« ï¼Œå‰é¢çš„æ¯ä¸€å€‹éƒ½æ˜¯é‡è¦çš„å…ƒç´ ï¼Œä½†è¦æ€éº¼æ•´åˆèµ·ä¾†æœƒåœ¨é€™ç¯‡å®Œæ•´çš„äº¤ä»£

<!-- more -->

> å¦‚æœé‚„æ²’çœ‹éç³»åˆ—å…¶ä»–ç¯‡çš„éº»ç…©é€™é‚Šè«‹
> {% post_link css-scale-position %}ã€{% post_link canvas-drawimage %}ã€{% post_link css-mask%}ã€{% post_link crop-drag %}

> ä½¿ç”¨reactä½œç‚ºç¯„ä¾‹

# æº–å‚™ç•«é¢

æ—¢ç„¶é€™æ˜¯æœ€çµ‚ç« ï¼Œç•¶ç„¶å°±æ˜¯è¦æŠŠç•«é¢ä»€éº¼çš„éƒ½æº–å‚™å¥½å•¦ï¼Œé€™é‚Šå°±ç›´æ¥ä¾†æŠŠhtmlã€cssæº–å‚™å¥½
ç•«é¢çš„åŠŸèƒ½æ˜¯é€™æ¨£ï¼Œä¸€é–‹å§‹é€²å»è¦å…ˆä¸Šå‚³åœ–ç‰‡ï¼Œç„¶å¾Œæ¥è‘—å¯ä»¥é–‹å§‹æ”¾å¤§/ç¸®å°/ç§»å‹•ï¼Œæœ€å¾ŒæŒ‰ä¸‹ç¢ºå®šï¼ŒæŠŠå€åŸŸå…§çš„ç•«é¢é¡¯ç¤ºå‡ºä¾†

## html

```html
<div>
    <input
      class="file-input"
      type="file"
      accept='image/*'
    />
    <div class="crop-root">
        <div class="photo-block">
            <div class="photo-mask">
              <img draggable="false" />
            </div>
            <img draggable="false" />
            <div class="zoom-block">
              <div class="zoom-out" />
              <input
                class="slide"
                type="range"
                min="1"
                max="1.5"
                step="0.01"
              />
              <div class="zoom-in" />
            </div>
        </div>
        <div class="button-block">
            <button>
              cut
            </button>
        </div>
    </div>
    <!-- æœ€å¾Œé¡¯ç¤ºç”¨ -->
    <img />
</div>
```

## css

```scss
.crop-root{
    border: 1px solid #808080;
    position: relative;
}

.photo-block{
    height: 440px;
    max-width: 500px;
    position: relative;
    overflow: hidden;

    img{
      display: block;
      position: absolute;
      object-fit: contain;
      max-width: 100%;
    }
    
    & > img{
        background: #ffffff;
        opacity: 0.6;
    }
}

.photo-mask{
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  clip-path: circle(125px at center 180px);
}

.zoom-block{
  display: flex;
  position: absolute;
  bottom: 0;
  padding: 18px 0;
  width: 100%;
  background-color: white;
  justify-content: center;
}

%zoomIconLine{
    content: '';
    display: block;
    height: 2px;
    width: 0.75rem;
    border-radius: 1px;
    background-color: #808080;
    position: absolute;
    top: calc(50% - 1px);
}

%zoomIcon{
    width: 1rem;
    height: 1rem;
    display: flex;
    justify-content: center;
    cursor: pointer;
}

.zoom-out{
    @extend %zoomIcon;

    &:before{
        @extend %zoomIconLine;
    }
}

.zoom-in{
    @extend %zoomIcon;

    &:before{
        @extend %zoomIconLine;
        transform: rotate(-90deg);
    }

    &:after{
        @extend %zoomIconLine;
    }
}
```

# scaleå’Œdragçµåˆ

## scaleè¨ˆç®—

å‰é¢ç”¨äº†å…©ç¯‡å„è‡ªçš„è¬›åˆ°scaleå’Œdragï¼Œä½†æ˜¯é€™å…©å€‹çµåˆåœ¨ä¸€èµ·ä»¥å¾Œè¨ˆç®—çš„æ–¹å¼ä¸€å®šæœƒæœ‰æ‰€ä¸ä¸€æ¨£ï¼Œç¾åœ¨æˆ‘å€‘è¦æŠŠé€™å¡Šå®Œæˆ

```javascript
const parent = this.dragNode.parentNode;
const maxLeft = parent.offsetWidth - this.dragNode.offsetWidth;
const maxTop = parent.offsetHeight - this.dragNode.offsetHeight;

point = {
  left: this.validValue(point.left, 0, maxLeft),
  top: this.validValue(point.top, 0, maxTop),
};
```

ä¸Šé¢æ˜¯å‰ä¸€ç¯‡æ‰€ç”¨çš„æ–¹æ³•ï¼Œå¦‚æœä¸ç®¡é‚Šç•Œå€¼ï¼Œæˆ‘å€‘åªè¦æŠŠ`this.dragNode`çš„`offsetWidth`ä¹˜ä¸Šscaleå€¼å°±å¯ä»¥

```javascript
const parent = this.dragNode.parentNode;
const maxLeft = parent.offsetWidth - (this.dragNode.offsetWidth * zoomValue);
const maxTop = parent.offsetHeight - (this.dragNode.offsetHeight * zoomValue);
```

æ¥ä¸‹ä¾†æˆ‘å€‘è¦æŠŠé‚Šç•Œçš„æ¢ä»¶æ‹‰è¿‘ä¾†ï¼Œä¸¦ä¸”é‚Šç•Œå¾å››å‘¨æ”¹æˆä¸­é–“çš„åœ“ï¼Œä¹Ÿå°±æ˜¯åœ–ç‰‡ä¸èƒ½è¶…éåœ“å½¢çš„ç¯„åœï¼Œå› æ­¤è¨ˆç®—çš„æ–¹å¼è¦é‡æ–°ä¾†

## åœ“ç‚ºé‚Šç•Œ

å‰é¢æˆ‘å€‘æ‰€ç”¨åˆ°çš„é‚Šç•Œå–å€¼çš„æ–¹å¼é‚„è¨˜å¾—å—ï¼Œ**ä½¿ç”¨ç›®å‰å€¼å’Œæœ€å¤§æœ€å°åšè¨ˆç®—**ã€‚
ç”¨åœ“ç•¶åšé‚Šç•Œä¹Ÿæ˜¯ä¸€æ¨£ï¼Œæˆ‘å€‘è¦æ‹¿åˆ°åœ“çš„ä¸Šä¸‹å·¦å³å››å€‹å€¼ï¼Œè€Œä¸èƒ½å·æ‡¶ç›´æ¥ç”¨0ç•¶åšæœ€å°å€¼ï¼Œé€™é‚Šå…ˆä¾†å€‹æš–èº«æ²’æœ‰ä»»ä½•scaleçš„å•é¡Œè¦å¸¶å…¥

æˆ‘å€‘åªè¦æ‹¿ä¸€é‚Šä¾†åšè¨ˆç®—ï¼Œå› æ­¤æ€è€ƒçš„æ–¹å¼è¦èª¿æ•´ä¸€ä¸‹ï¼Œå…ˆä¾†çœ‹ä¸€ä¸‹æ“ä½œæ¨¡å¼
![move](move.gif)

ç•¶åœ–å·¦é‚Šæ‹‰åˆ°åœ“çš„å·¦é‚Šæ™‚å°±è¦åœæ­¢ï¼Œè€Œåé‚Šçš„è©±æ˜¯å·¦é‚Šæ‹‰åˆ°åœ“çš„å³é‚Šæ¸›å»å¯¬åº¦ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥ç”¨é€™å…©å€‹å€¼ç•¶åšæœ€å¤§å’Œæœ€å°

```javascript
const circle = {
    radius: 125,
    offsetY: 54,
};
//ã€€å–å¾—åœ“åœ¨dragå€åŸŸçš„offset
const photoRect = this.dragNode.parentNode.getBoundingClientRect();
let circleNode = {
  left: (photoRect.width / 2) - circle.radius,
  top: circle.offsetY,
};
circleNode = {
  ...circleNode,
  right: circleNode.left + (circle.radius * 2),
  bottom: circleNode.top + (circle.radius * 2),
};
//ã€€ä»¥ä¸Šçš„è¨ˆç®—åªéœ€è¦ä¸€æ¬¡ï¼Œæ‰€ä»¥å¯ä»¥æ”¾åœ¨ componentDidMount

const minLeft = circleNode.right - this.dragNode.offsetWidth;
const minHeight = circleNode.bottom - this.dragNode.offsetHeight;

point = {
  left: this.validValue(point.left, minLeft, circleNode.left),
  top: this.validValue(point.top, minHeight, circleNode.top),
};
```

ä¹ï½ç¬¬ä¸€ç‰ˆæå®šï¼Œé‚£æ¥è‘—å°±è¦æŠŠscaleçš„è®Šæ•¸åŠ é€²ä¾†ï¼

```javascript
const { offsetWidth, offsetHeight } = this.dragNode;
let minLeft = this.circleNode.right - (offsetWidth * zoomValue);
let minTop = this.circleNode.bottom - (offsetHeight * zoomValue);
let maxLeft = this.circleNode.left;
let maxTop = this.circleNode.top;
```

ä½†é€™è£¡æœ‰å€‹å•é¡Œæ˜¯ï¼Œåœ–æ”¾å¤§äº†ï¼Œä½†æ˜¯æˆ‘å€‘çš„åº§æ¨™æœ¬èº«æ˜¯æ²’æœ‰æ”¾å¤§ï¼Œå› æ­¤åœ¨åšmaxã€minçš„æ¯”è¼ƒæ™‚ï¼Œä¸èƒ½ç”¨æ”¾å¤§å¾Œçš„å€¼ä¾†é‹ç®—ï¼Œæ‡‰è©²è¦æ›ç®—å›æ­£ç¢ºçš„å€¼

```javascript
if (zoomValue > 1) {
  minLeft = this.calOriginPosition(offsetWidth, minLeft, zoomValue);
  minTop = this.calOriginPosition(offsetHeight, minTop, zoomValue);
  maxLeft = this.calOriginPosition(offsetWidth, maxLeft, zoomValue);
  maxTop = this.calOriginPosition(offsetHeight, maxTop, zoomValue);
}

const calOriginPosition = (originLength, value, zoomValue) =>
    value + ((zoomValue - 1) * originLength / 2);
```

## mobileæ”¾å¤§-pinch

{% post_link crop-drag å‰é¢ä¸€ç¯‡ %}æœ‰æåˆ°åœ¨mobileä¸Šçš„touchæ˜¯ä¸€å€‹é™£åˆ—ï¼Œç‚ºäº†å¯ä»¥è¨˜éŒ„å¤šé»è§¸æ§æ™‚çš„ä½ç½®ï¼Œåœ¨mobileä¸Šscaleæœ‰å€‹åè©å«åš**pinch**ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹é€™å¼µåœ–ä¸Šé¢æœ‰å„ç¨®åœ¨mobileä¸Šçš„æ“ä½œè¡Œç‚º
![gesture](gesturecard.jpg)

é€™é‚Šè·Ÿdragåªæœ‰ä¸€å€‹åœ°æ–¹è¦èª¿æ•´ï¼Œå°±æ˜¯ä¸€å®šè¦è§¸æ§å…©å€‹é»ï¼Œæ¥è‘—è®Šæ›´`zoomValue`å³å¯

```javscript
filter(event => event.touches.length === 2)
```

# è¼¸å‡º

dragå’Œscaleéƒ½è™•ç†å®Œä»¥å¾Œå°±åªå‰©ä¸‹æœ€å¾Œçš„è¼¸å‡ºï¼Œåœ¨å°ˆæ¡ˆä¸­ç‚ºäº†ä¸Šå‚³æ–¹ä¾¿ï¼Œå› æ­¤ä½¿ç”¨çš„æ˜¯`blob`ä¾†æ”¾æª”æ¡ˆï¼Œç•¶ç„¶ä½ ä¹Ÿèƒ½å¤ ä¸è¦è½‰ç›´æ¥ç”¨`base64`åšé¡¯ç¤ºï¼Œå› ç‚ºå·²ç¶“è½‰æˆblobï¼Œå› æ­¤æˆ‘å€‘éœ€è¦ç”¨**URL.createObjectURL**çš„æ–¹æ³•å»è½‰æ›æˆç€è¦½å™¨å…§éƒ¨çš„é€£çµ

```javascript
afterCutBlob = blob =>{
    const url = URL.createObjectURL(blob);
    this.setState({
        cutBlob: url,
    })
}
```

> ä¸è¦å¿˜è¨˜é›¢é–‹å‰é‡‹æ”¾ä¸€ä¸‹è¨˜æ†¶é«”ï¼Œå¯ä»¥åƒè€ƒä¸€ä¸‹é€™ç¯‡[MDN](https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL)ï¼Œåœ¨é€™ç¯‡ä¸­æˆ‘å°±æ²’æœ‰å¯«ä¸Šå»

# å°æ‡‰ç”¨

é€™æ˜¯ä¸€å€‹åœ¨å°ˆæ¡ˆä¸Šç”¨åˆ°çš„æƒ…å¢ƒï¼Œdesignerè·Ÿæˆ‘èªªå¸Œæœ›ä¸€é–‹å§‹é€²å»çš„æ™‚å¾Œï¼Œå¦‚æœé«˜æ¯”å¯¬é•·ï¼Œé‚£å°±å°‡å¯¬è¨­ç‚ºåœ“çš„ç›´å¾‘ï¼Œé«˜ç­‰æ¯”æ¯”ç¸®æ”¾ï¼Œç„¶å¾Œä½ç½®æ˜¯åœ¨åœ“çš„å·¦ä¸Šè§’

é€™å€‹éœ€æ±‚å…¶å¯¦å¾ˆç°¡å–®ï¼Œåœ¨imageåŠ ä¸Š`onLoad`çš„äº‹ä»¶ï¼Œå¯«å€‹åˆ¤æ–·å¼ï¼Œç„¶å¾Œå†æŠŠleftå’Œtopé‡æ–°è¨ˆç®—å–å¾—æ­£ç¢ºçš„ä½ç½®ï¼Œå°±å¯ä»¥æ‰“å®Œæ”¶å·¥å•¦

```javascript
  loadedImage = () => {
    const {
      naturalHeight,
      naturalWidth,
    } = this.image;

    const stateName = naturalHeight > naturalWidth ? 'width' : 'height';
    const diameter = circle.radius * 2;
    this.image[stateName] = diameter;
    this.setState({
      [stateName]: diameter,
    });

    const {
      left,
      top,
      zoomValue,
    } = this.state;
    this.calMovedPosition({
      left,
      top,
    }, zoomValue);
  }
/*
<img
  src={imageBlob}
  style={imageStyle}
  draggable="false"
  ref={node => { this.image = node; }}
  onLoad={this.loadedImage}
/>
*/
```



# çµè«–

åˆ°é€™é‚Šï¼Œæ•´å€‹åŠŸèƒ½å·²ç¶“ç®—æ˜¯ä»‹ç´¹çš„å·®ä¸å¤šï¼Œå‰©ä¸‹çš„å°±æ˜¯æŠŠå‰é¢æ‰€è¬›éçš„ç¨‹å¼ç¢¼æ‹¼æ¹Šèµ·ä¾†ï¼Œéœ€è¦çš„è©±è«‹åˆ°é€™é‚Šçœ‹[demo](https://stackblitz.com/edit/react-crop?embed=1&file=index.js&view=editor)

åœ¨é€™é‚Šæˆ‘ç”¨çš„æ˜¯å…©å€‹imageæ­é…å‡ºä¾†çš„æ•ˆæœï¼Œä½†å…¶å¯¦ä¹Ÿæœ‰å¦ä¸€å€‹ä½œæ³•æ˜¯ç”¨canvasç›´æ¥ç•«ï¼Œå¦‚æœæœ‰éœ€è¦çš„è©±å¯ä»¥ç ”ç©¶ä¸€ä¸‹æ€éº¼åšï¼Œä½†æˆ‘æƒ³ä½œæ³•æ‡‰è©²æ˜¯ä¸æœƒå·®å¤ªå¤š

åœ¨é€™æ•´å€‹ç³»åˆ—ä¸­ï¼Œæœ€éº»ç…©çš„ä¸€å®šå°±æ˜¯è·Ÿscaleæ‰¯ä¸Šé—œä¿‚ï¼Œä¸€æœ‰é—œä¿‚ä»¥å¾Œæ•´å€‹è¨ˆç®—å°±è®Šå¾—éº»ç…©ï¼Œä¸æ–·çš„åœ¨åšè½‰æ›çš„å‹•ä½œï¼Œå…¶å¯¦é€™åŠŸèƒ½ä¸é›£ï¼Œåªæ˜¯åœ¨æ–¼ä¸€äº›å°ç´°ç¯€ä¸Šè¦æ³¨æ„ï¼Œè¸©éäº†å°±çŸ¥é“XD

> ç¯„ä¾‹ä¸­çš„`Crop`é€™å€‹componentæ²’å¯«çš„å¾ˆå¥½ï¼Œåšå¤ªå¤šäº‹æƒ…ï¼Œå¦‚æœæœ‰ä»€éº¼å¥½çš„å»ºè­°æ­¡è¿å‘Šè¨´æˆ‘å–”ğŸ¥‚